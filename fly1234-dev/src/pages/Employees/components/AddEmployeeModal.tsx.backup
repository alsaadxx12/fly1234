import React from 'react';
import { createUserWithEmailAndPassword } from 'firebase/auth';
import { auth, db } from '../../../lib/firebase'; 
import { addEmployee, type Employee, getEmployees } from '../../../lib/collections/employees';
import { useLanguage } from '../../../contexts/LanguageContext';
import { Users, X, UserCircle, Mail, Phone, DollarSign, Clock, Box, Loader2, Key, AlertCircle, Info, Check, Shield } from 'lucide-react';
import { collection, getDocs, query, orderBy, where } from 'firebase/firestore';
import EmployeePermissionSelector from './EmployeePermissionSelector';

type Props = {
  isOpen: boolean;
  onClose: () => void;
};

interface EmployeeFormData {
  fullName: string;
  email: string;
  password: string;
  phone: string;
  salary: number;
  shift: 'morning' | 'evening' | 'night';
  permissionGroupId: string;
  safeId: string;
}

interface Permission {
  id: string;
  name: string;
  permissions: Record<string, string[] | boolean>;
}

const AddEmployeeModal = ({ isOpen, onClose }: Props) => {
  const { t } = useLanguage();
  const [formData, setFormData] = React.useState<EmployeeFormData>({
    fullName: '',
    email: '',
    password: '',
    phone: '',
    salary: 0,
    shift: 'morning',
    permissionGroupId: '',
    safeId: ''
  });
  const [error, setError] = React.useState<string | null>(null);
  const [isLoading, setIsLoading] = React.useState(false);
  const [isLoadingPermissions, setIsLoadingPermissions] = React.useState(true);
  const [isFetchingSafes, setIsFetchingSafes] = React.useState(true);
  const [success, setSuccess] = React.useState<string | null>(null);
  const [permissions, setPermissions] = React.useState<Permission[]>([]);
  const [safesList, setSafesList] = React.useState<Array<{ id: string; name: string }>>([]);
  const [existingEmails, setExistingEmails] = React.useState<string[]>([]);

  // Fetch safes
  React.useEffect(() => {
    const fetchSafes = async () => {
      try {
        setIsFetchingSafes(true);
        const safesRef = collection(db, 'safes');
        const q = query(safesRef, orderBy('name', 'asc'));
        const snapshot = await getDocs(q);
        
        const safesData = snapshot.docs.map(doc => ({
          id: doc.id,
          name: doc.data().name
        }));
        
        setSafesList(safesData);
      } catch (error) {
        console.error('Error fetching safes:', error);
        setError('فشل في تحميل الصناديق');
      } finally {
        setIsFetchingSafes(false);
      }
    };

    fetchSafes();
  }, []);

  // Fetch permission groups
  React.useEffect(() => {
    const fetchPermissions = async () => {
      try {
        setIsLoadingPermissions(true);
        const permissionsRef = collection(db, 'permissions');
        const q = query(permissionsRef, orderBy('name', 'asc'));
        const snapshot = await getDocs(q);
        
        const permissionsData = snapshot.docs.map(doc => ({
          id: doc.id,
          name: doc.data().name,
          permissions: doc.data().permissions
        }));

        setPermissions(permissionsData);
      } catch (error) {
        console.error('Error fetching permissions:', error);
        setError('فشل في تحميل مجموعات الصلاحيات');
      } finally {
        setIsLoadingPermissions(false);
      }
    };

    fetchPermissions();
  }, [isOpen]);

  // Check for existing emails to prevent duplicates
  React.useEffect(() => {
    const fetchExistingEmails = async () => {
      try {
        const employees = await getEmployees();
        const emails = employees.map(emp => emp.email.toLowerCase());
        setExistingEmails(emails);
      } catch (error) {
        console.error('Error fetching existing emails:', error);
      }
    };

    fetchExistingEmails();
  }, [isOpen]);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError(null);
    setSuccess(null);
    setIsLoading(true);
    
    try {
      // Check if email already exists
      if (existingEmails.includes(formData.email.toLowerCase())) {
        throw new Error('البريد الإلكتروني مستخدم بالفعل');
      }

      // Validate password strength
      if (formData.password.length < 8) {
        throw new Error('يجب أن تكون كلمة المرور 8 أحرف على الأقل');
      }

      // First create Firebase auth user
      const userCredential = await createUserWithEmailAndPassword(
        auth,
        formData.email,
        formData.password
      );

      // Then create employee document linked to auth user
      const employeeData: Omit<Employee, 'id' | 'createdAt' | 'updatedAt'> = {
        name: formData.fullName,
        email: formData.email,
        phone: formData.phone,
        role: formData.permissionGroupId,
        salary: formData.salary,
        startDate: new Date(),
        isActive: true,
        userId: userCredential.user.uid // Link to auth user
      };

      await addEmployee(employeeData);

      // Show success message
      setSuccess('تم إضافة الموظف بنجاح');
      
      // Close modal after delay
      setTimeout(() => {
        onClose();
        // Reset form
        setFormData({
          fullName: '', email: '', password: '', phone: '',
          salary: 0, shift: 'morning', permissionGroupId: '', safeId: ''
        });
      }, 2000);
    } catch (error) {
      console.error('Error adding employee:', error);
      if (error instanceof Error) {
        if (error.message.includes('email-already-in-use')) {
          setError('البريد الإلكتروني مستخدم بالفعل');
        } else {
          setError('فشل في إضافة الموظف');
        }
      } else {
        setError('فشل في إضافة الموظف');
      }
    } finally {
      setIsLoading(false);
    }
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4">
      <div className="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl overflow-hidden" onClick={e => e.stopPropagation()}>
        {/* Header */}
        <div className="p-5 border-b border-gray-200 dark:border-gray-700">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg">
                <Users className="w-5 h-5 text-gray-700 dark:text-gray-300" />
              </div>
              <div>
                <h3 className="text-lg font-bold text-gray-900 dark:text-white">إضافة موظف جديد</h3>
                <p className="text-sm text-gray-600 dark:text-gray-400">إضافة موظف جديد إلى النظام</p>
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg">
              <X className="w-5 h-5" />
            </button>
          </div>
        </div>
        
        <div className="p-4 max-h-[80vh] overflow-y-auto">
          {success && (
            <div className="p-3 bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400 rounded-lg mb-4 flex items-center gap-2 border border-green-200 dark:border-green-800">
              <Check className="w-5 h-5 flex-shrink-0" />
              <p>{success}</p>
            </div>
          )}

          {error && (
            <div className="p-3 bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 rounded-lg mb-4 flex items-center gap-2 border border-red-200 dark:border-red-800">
              <AlertCircle className="w-5 h-5 flex-shrink-0" />
              <p>{error}</p>
            </div>
          )}

          <form id="employeeForm" onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
                  {t('fullName')}
                </label>
                <div className="relative">
                  <input
                    type="text"
                    value={formData.fullName}
                    onChange={(e) => setFormData(prev => ({ ...prev, fullName: e.target.value }))}
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 pr-10"
                    placeholder="أدخل الاسم الكامل"
                    required
                  />
                  <div className="absolute right-3 top-2.5">
                    <UserCircle className="w-5 h-5 text-gray-400" />
                  </div>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
                  {t('email')}
                </label>
                <div className="relative">
                  <input
                    type="email"
                    value={formData.email}
                    onChange={(e) => setFormData(prev => ({ ...prev, email: e.target.value }))}
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 pr-10"
                    placeholder="example@company.com"
                    dir="ltr"
                    required
                  />
                  <div className="absolute right-3 top-2.5">
                    <Mail className="w-5 h-5 text-gray-400" />
                  </div>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
                  {t('password')}
                </label>
                <div className="relative">
                  <input
                    type="password"
                    value={formData.password}
                    onChange={(e) => setFormData(prev => ({ ...prev, password: e.target.value }))}
                    className="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-400 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 pr-10"
                    placeholder="••••••••"
                    required
                    minLength={8}
                  />
                  <div className="absolute right-3 top-2.5">
                    <Key className="w-5 h-5 text-gray-400" />
                  </div>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1.5">
                  {t('phone')}
                </label>
                <div className="relative">
                  <input
                    type="tel"
                      value={formData.phone}
                      onChange={(e) => setFormData(prev => ({ ...prev, phone: e.target.value }))}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white text-secondary-800 pr-10"
                      placeholder="05xxxxxxxx"
                      dir="ltr"
                      required
                    />
                    <div className="absolute right-3 top-3">
                      <Phone className="w-5 h-5 text-gray-400" />
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Job Information Section */}
              <div className="bg-white rounded-lg p-3 border border-gray-200 space-y-3 shadow-sm">
                <h4 className="text-xs font-medium text-secondary-800 mb-1 flex items-center gap-2">
                  <Box className="w-4 h-4 text-primary" />
                  معلومات الوظيفة
                  <span className="text-xs text-gray-500">(مطلوبة)</span>
                </h4>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1.5">
                    {t('salary')}
                  </label>
                  <div className="relative group">
                    <input
                      type="text"
                      value={formData.salary}
                      onChange={(e) => {
                        // Only allow numbers and decimal point
                        const value = e.target.value.replace(/[^0-9.]/g, '');
                        // Prevent multiple decimal points
                        const parts = value.split('.');
                        if (parts.length > 2) return;
                        
                        setFormData(prev => ({ 
                          ...prev, 
                          salary: value ? parseFloat(value) : 0 
                        }));
                      }}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white text-secondary-800 pr-10"
                      placeholder="1500"
                      dir="ltr"
                      required
                      pattern="[0-9]*\.?[0-9]*"
                      inputMode="decimal"
                    />
                    <div className="absolute right-3 top-3">
                      <DollarSign className="w-5 h-5 text-gray-400" />
                    </div>
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1.5">
                    {t('shift')}
                  </label>
                  <div className="relative group">
                    <select
                      value={formData.shift}
                      onChange={(e) => setFormData(prev => ({ ...prev, shift: e.target.value as 'morning' | 'evening' | 'night' }))}
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white text-secondary-800 pr-10 appearance-none"
                      required
                    >
                      <option value="">{t('selectShift')}</option>
                      <option value="morning">{t('morningShift')}</option>
                      <option value="evening">{t('eveningShift')}</option>
                      <option value="night">{t('nightShift')}</option>
                    </select>
                    <div className="absolute right-3 top-3">
                      <Clock className="w-5 h-5 text-gray-400" />
                    </div>
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1.5">
                    {t('permissionGroup')}
                  </label>
                  <div className="relative group">
                    {isLoadingPermissions ? (
                      <div className="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-500 flex items-center justify-center gap-2">
                        <Loader2 className="w-4 h-4 animate-spin text-gray-500" />
                        <span>{t('loading')}...</span>
                      </div>
                    ) : (
                      <select
                        value={formData.permissionGroupId}
                        onChange={(e) => setFormData(prev => ({ ...prev, permissionGroupId: e.target.value }))}
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white text-secondary-800 pr-10 appearance-none"
                        required
                      >
                        <option value="">{t('selectGroup')}</option>
                        {permissions.map(permission => (
                          <option key={permission.id} value={permission.id}>
                            {permission.name} {permission.permissions?.isAdmin ? '(مدير النظام)' : ''} 
                          </option>
                        ))}
                      </select>
                    )}
                    <div className="absolute right-3 top-3">
                      <Shield className="w-5 h-5 text-gray-400" />
                    </div>
                  </div>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1.5">
                    {t('safe')}
                  </label>
                  <div className="relative group">
                    {isFetchingSafes ? (
                      <div className="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-500 flex items-center justify-center gap-2">
                        <Loader2 className="w-4 h-4 animate-spin text-gray-500" />
                        <span>{t('loading')}...</span>
                      </div>
                    ) : (
                      <select
                        value={formData.safeId}
                        onChange={(e) => setFormData(prev => ({ ...prev, safeId: e.target.value }))}
                        className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary bg-white text-secondary-800 pr-10 appearance-none"
                        required
                      >
                        <option value="">{t('selectSafe')}</option>
                        {safesList.map(safe => (
                          <option key={safe.id} value={safe.id}>{safe.name}</option> 
                        ))}
                      </select>
                    )}
                    <div className="absolute right-3 top-3">
                      <Box className="w-5 h-5 text-gray-400" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div className="flex items-center justify-end gap-3 pt-3 border-t border-gray-200 sticky bottom-0 bg-white z-10">
              <button
                type="button"
                onClick={onClose}
                className="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors text-sm"
              >
                {t('cancel')}
              </button>
              <button
                type="submit"
                disabled={isLoading}
                className="flex items-center gap-2 px-4 py-2 text-white bg-gray-700 hover:bg-gray-800 dark:bg-gray-600 dark:hover:bg-gray-700 rounded-lg disabled:opacity-50"
              >
                {isLoading ? (
                  <>
                    <Loader2 className="w-5 h-5 animate-spin" />
                    <span>جاري الإضافة...</span>
                  </>
                ) : (
                  <>
                    <Users className="w-5 h-5" />
                    <span>{t('addEmployee')}</span>
                  </>
                )}
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  );
};

export default AddEmployeeModal;