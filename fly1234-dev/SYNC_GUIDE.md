# دليل نظام المزامنة المستمرة للأرصدة

## نظرة عامة

تم إضافة نظام مزامنة مستمر جديد يعمل في الخلفية لتحديث أرصدة خطوط الطيران تلقائياً وبشكل مستمر.

## المميزات الجديدة

### 1. المزامنة المستمرة (Continuous Sync)
- تعمل في الخلفية بشكل مستمر
- لا تعتمد على فترات زمنية محددة مسبقاً لكل اتصال
- يمكن تفعيلها/إيقافها بضغطة زر واحدة
- تحفظ الحالة حتى بعد إعادة تشغيل المتصفح

### 2. التحكم الكامل
- **تفعيل/إيقاف فوري**: زر Toggle للتحكم السريع
- **ضبط الفترة الزمنية**: من 10 ثواني إلى 300 ثانية
- **مزامنة فورية**: زر لتشغيل المزامنة فوراً في أي وقت
- **مراقبة مباشرة**: عرض حالة المزامنة في الوقت الفعلي

### 3. واجهة مستخدم محسّنة
- بطاقة خاصة للمزامنة المستمرة في أعلى الصفحة
- مؤشرات بصرية واضحة (قيد التشغيل / متوقف)
- عرض تقدم المزامنة الحالية
- إحصائيات فورية (عدد النجاح/الفشل)
- عرض وقت آخر مزامنة

## كيفية الاستخدام

### الإعداد الأولي

1. **إضافة اتصالات API**:
   - افتح صفحة "ربط API خطوط الطيران"
   - اضغط "إضافة اتصال جديد"
   - أدخل بيانات الاتصال الكاملة
   - اختبر الاتصال للتأكد من صحة البيانات
   - احفظ الاتصال

2. **التأكد من تفعيل الاتصالات**:
   - تأكد من أن الاتصالات التي تريد مزامنتها في حالة "نشط"
   - الاتصالات المتوقفة لن يتم مزامنتها

### تفعيل المزامنة المستمرة

1. **ابحث عن بطاقة "المزامنة المستمرة"** في أعلى الصفحة (لون أخضر)

2. **اضبط فترة التحديث**:
   - الفترة الافتراضية: 30 ثانية
   - الحد الأدنى: 10 ثواني
   - الحد الأقصى: 300 ثانية (5 دقائق)
   - يُنصح باستخدام 30-60 ثانية للتوازن بين السرعة والأداء

3. **فعّل المزامنة**:
   - اضغط على زر Toggle
   - سيتحول إلى اللون الأخضر
   - ستبدأ المزامنة تلقائياً

### المراقبة والتحكم

#### أثناء التشغيل
- **مؤشر الحالة**: "قيد التشغيل" باللون الأخضر
- **شريط التقدم**: يظهر عند بدء عملية المزامنة
- **الاتصال الحالي**: يعرض اسم الاتصال الذي يتم مزامنته
- **الإحصائيات**: عدد الاتصالات الناجحة والفاشلة

#### بعد كل مزامنة
- يتم تحديث وقت آخر مزامنة
- يتم تحديث حالة كل اتصال (نجاح/فشل)
- يتم حفظ رسائل الأخطاء إن وجدت

### المزامنة الفورية

إذا كنت تريد تحديث الأرصدة فوراً دون انتظار:
1. اضغط على زر "مزامنة فورية"
2. سيتم تشغيل المزامنة على الفور لجميع الاتصالات النشطة

### إيقاف المزامنة

لإيقاف المزامنة المستمرة:
1. اضغط على زر Toggle مرة أخرى
2. سيتحول إلى اللون الرمادي
3. ستتوقف المزامنة التلقائية فوراً

## التقنيات المستخدمة

### ApiSyncService
خدمة متخصصة للمزامنة المستمرة:
- تعمل بنظام Interval للتكرار التلقائي
- تدعم الإيقاف والتشغيل الديناميكي
- تتعامل مع الأخطاء بشكل ذكي
- تحفظ الحالة في localStorage

### المزايا التقنية
- **Non-blocking**: لا تعطل واجهة المستخدم
- **Error handling**: معالجة متقدمة للأخطاء
- **State management**: إدارة حالة محسّنة
- **Real-time updates**: تحديثات فورية للواجهة
- **Persistent state**: تحفظ الإعدادات بين الجلسات

## نصائح الاستخدام

### الأداء الأمثل
- استخدم 30 ثانية للمواقع السريعة
- استخدم 60 ثانية للاستخدام العادي
- استخدم 120+ ثانية للمواقع البطيئة

### توفير الموارد
- أوقف المزامنة عند عدم الحاجة إليها
- قلل عدد الاتصالات النشطة إذا كانت غير مستخدمة
- استخدم المزامنة الفورية للتحديثات العاجلة فقط

### حل المشاكل

**المزامنة لا تعمل:**
1. تأكد من تفعيل Toggle
2. تأكد من وجود اتصالات نشطة
3. تحقق من صحة بيانات الاتصال

**أخطاء متكررة:**
1. راجع رسالة الخطأ في بطاقة الاتصال
2. اختبر الاتصال يدوياً
3. تحقق من صلاحية بيانات الدخول

**بطء في الأداء:**
1. زِد فترة التحديث
2. قلل عدد الاتصالات النشطة
3. أعد تشغيل المتصفح

## الفرق بين النظام القديم والجديد

### النظام القديم (autoSync)
- كان يعتمد على إعدادات كل اتصال على حدة
- فترة زمنية مختلفة لكل اتصال
- معقد في الإدارة
- لا يوجد تحكم مركزي

### النظام الجديد (Continuous Sync)
- نظام مركزي موحد
- تحكم كامل من مكان واحد
- واجهة بسيطة وواضحة
- مراقبة فورية للحالة
- أداء أفضل وأكثر كفاءة

## الأمان والخصوصية

- جميع البيانات محفوظة بشكل آمن في Firestore
- لا يتم إرسال بيانات الدخول إلا للـ API المحدد
- المزامنة تتم في الخلفية دون التأثير على الأمان
- يتم حفظ إعدادات المزامنة محلياً فقط

## الدعم الفني

في حالة وجود أي مشاكل:
1. تحقق من اتصال الإنترنت
2. راجع console المتصفح للأخطاء
3. تأكد من صحة إعدادات Firebase
4. أعد تشغيل المتصفح

---

**ملاحظة**: هذا النظام يعمل طالما المتصفح مفتوح. إذا أغلقت المتصفح، ستتوقف المزامنة ويجب تفعيلها مرة أخرى عند فتحه.
